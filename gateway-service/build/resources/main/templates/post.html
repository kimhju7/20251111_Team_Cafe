<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ë¸”ë¡œê·¸ ê²Œì‹œíŒ</title>
    <style>
        body { font-family: Arial; margin: 40px; }
        input, textarea { width: 100%; margin-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; }
        th { background: #f5f5f5; }
        button { padding: 5px 10px; margin: 2px; }
        h1 { color: #444; }
        a { text-decoration: none; color: #007bff; }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>
<nav style="padding:10px; background:#f5f5f5; margin-bottom:20px;">
    <a href="/" style="margin-right:10px;">ğŸ  í™ˆ</a>
    <a href="/posts" style="margin-right:10px;">ğŸ“ ê²Œì‹œê¸€</a>
    <a href="/categorys">ğŸ“‚ ì¹´í…Œê³ ë¦¬</a>
    <span style="float:right; color:#666;">Gateway</span>
    </nav>
<h1>ğŸ“ ë¸”ë¡œê·¸ ê²Œì‹œíŒ</h1>

<!-- ê²Œì‹œê¸€ ì‘ì„± -->
<div>
    <h3>ê²Œì‹œê¸€ ì‘ì„±</h3>
    <input type="hidden" id="postId">
    <input type="text" id="title" placeholder="ì œëª©">
    <input type="text" id="author" placeholder="ì‘ì„±ì">
    <select id="categoryId">
        <option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ(ì„ íƒì‚¬í•­)</option>
    </select>
    <textarea id="content" rows="5" placeholder="ë‚´ìš©"></textarea>
    <button onclick="savePost()">ì €ì¥</button>
    <button onclick="clearForm()">ì·¨ì†Œ</button>
</div>

<!-- ê²Œì‹œê¸€ ëª©ë¡ -->
<table>
    <thead>
    <tr>
        <th>ID</th><th>ì œëª©</th><th>ì‘ì„±ì</th><th>ì¹´í…Œê³ ë¦¬</th><th>ì‘ì„±ì¼</th><th>ê´€ë¦¬</th>
    </tr>
    </thead>
    <tbody id="postList"></tbody>
</table>

<script>
    // ì¹´í…Œê³ ë¦¬ ìºì‹œ ë° í‘œì‹œ í•¨ìˆ˜
    let categoryCache = [];

    function renderCategoryName(categoryId) {
        if (!categoryId) return '';
        const c = categoryCache.find(x => x.id === categoryId);
        return c ? c.name : '';
    }

    // ê²Œì‹œê¸€ ëª©ë¡ ë¡œë“œ
    async function loadPosts() {
        const res = await fetch('/api/posts');
        const posts = await res.json();
        const tbody = document.getElementById('postList');
        tbody.innerHTML = posts.map(p => `
        <tr>
            <td>${p.id}</td>
            <td><a href="/posts/${p.id}">${p.title}</a></td>
            <td>${p.author}</td>
            <td>${renderCategoryName(p.categoryId)}</td>
            <td>${p.createdAt ? p.createdAt.replace('T', ' ') : ''}</td>
            <td>
                <button onclick="editPost(${p.id})">ìˆ˜ì •</button>
                <button onclick="deletePost(${p.id})">ì‚­ì œ</button>
            </td>
        </tr>
    `).join('');
    }

    // ì¹´í…Œê³ ë¦¬ ëª©ë¡ ë¡œë“œ
    async function loadCategoryOptions(selectedId) {
        try {
            const res = await fetch('/api/categorys');
            const categories = await res.json();
            categoryCache = categories;
            const select = document.getElementById('categoryId');
            select.innerHTML = '<option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ(ì„ íƒì‚¬í•­)</option>' +
                categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            if (selectedId !== undefined && selectedId !== null) {
                select.value = selectedId ?? '';
            }
        } catch (e) {
            console.error('ì¹´í…Œê³ ë¦¬ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨', e);
        }
    }

    // ê²Œì‹œê¸€ ì €ì¥ (ì‹ ê·œ/ìˆ˜ì •)
    async function savePost() {
        const id = document.getElementById('postId').value;
        const title = document.getElementById('title').value;
        const author = document.getElementById('author').value;
        const content = document.getElementById('content').value;
        const categoryIdValue = document.getElementById('categoryId').value;
        const categoryId = categoryIdValue === '' ? null : Number(categoryIdValue);

        if (!title.trim() || !author.trim() || !content.trim()) {
            alert('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
            return;
        }

        const post = { title, author, content, categoryId };

        const res = await fetch(id ? `/api/posts/${id}` : '/api/posts', {
            method: id ? 'PUT' : 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(post)
        });

        if (res.ok) {
            alert('ì €ì¥ ì™„ë£Œ!');
            clearForm();
            loadPosts();
        } else {
            const msg = await res.text();
            alert('ì €ì¥ ì‹¤íŒ¨: ' + msg);
        }
    }

    // ê²Œì‹œê¸€ ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì‹œ ê¸°ì¡´ ë°ì´í„° ì±„ìš°ê¸°
    async function editPost(id) {
        const res = await fetch(`/api/posts/${id}`);
        const post = await res.json();
        document.getElementById('postId').value = post.id;
        document.getElementById('title').value = post.title;
        document.getElementById('author').value = post.author;
        document.getElementById('content').value = post.content;
        await loadCategoryOptions(post.categoryId ?? '');
        window.scrollTo(0, 0);
    }

    // ê²Œì‹œê¸€ ì‚­ì œ
    async function deletePost(id) {
        if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        await fetch(`/api/posts/${id}`, { method: 'DELETE' });
        loadPosts();
    }

    // í¼ ì´ˆê¸°í™”
    function clearForm() {
        document.getElementById('postId').value = '';
        document.getElementById('title').value = '';
        document.getElementById('author').value = '';
        document.getElementById('content').value = '';
        loadCategoryOptions('');
    }

    loadPosts();
    loadCategoryOptions('');
</script>
</body>
</html>
